name: Users API CI/CD

on:
  workflow_dispatch:
  push:
    branches: [ 'master', 'dev' ]
  pull_request:
    branches: [ 'master', 'dev' ]

env:
  USERS_API_IMAGE: ${{ vars.DOCKER_PREFIX }}:users-api
  JWT_SECRET: ${{ secrets.JWT_SECRET }}

  # Common
  BRANCH_DEV: ${{ vars.BRANCH_DEV }}
  GITHUB_REF: ${{ github.ref }}

  SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
  SSH_USERNAME: ${{ secrets.SSH_USERNAME }}

  DOCKER_PREFIX: ${{ vars.DOCKER_PREFIX }}
  DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKER_NETWORK: ${{ vars.DOCKER_NETWORK }}
  DOCKER_NETWORK_GATEWAY: ${{ vars.DOCKER_NETWORK_GATEWAY }}
  DOCKER_NETWORK_IP_RANGE: ${{ vars.DOCKER_NETWORK_IP_RANGE }}
  DOCKER_NETWORK_SUBNET: ${{ vars.DOCKER_NETWORK_SUBNET }}

  USERS_API_HOST_HTTP: ${{ secrets.USERS_API_HOST_HTTP }}
  USERS_API_IP: ${{ vars.USERS_API_IP }}
  USERS_API_PORT: ${{ vars.USERS_API_PORT }}
  DATABASE_IP: ${{ vars.DATABASE_IP }}
  DATABASE_PORT: ${{ vars.DATABASE_PORT }}
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_PORT: ${{ secrets.SSH_PORT }}

  CONNECTION_CHECK_INTERVAL_MS: ${{ vars.CONNECTION_CHECK_INTERVAL_MS }}
  SPECS_DATA_AMOUNT: ${{ vars.SPECS_DATA_AMOUNT }}
  SPECS_HOOK_TIMEOUT_MS: ${{ vars.SPECS_HOOK_TIMEOUT_MS }}

jobs:
  check:
    name: Check files
    outputs:
      delta: ${{ steps.check.outputs.delta }}
    runs-on: ubuntu-latest
    env:
      EVENT_NAME: ${{ github.event_name }}
      EVENT_BEFORE: ${{ github.event.before }}
      EVENT_AFTER: ${{ github.event.after }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: ${{ github.event_name == 'pull_request' && 2 || 0 }}

      - name: Check modified Users API source files
        id: check
        shell: bash
        run: bash scripts/check-files.sh users-api

  ci:
    name: Users API CI
    runs-on: ubuntu-latest
    needs: check
    if: needs.check.outputs.delta == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Create Docker network
        run: |
          echo $DOCKER_NETWORK_SUBNET
          echo $DOCKER_NETWORK_GATEWAY
          echo $DOCKER_NETWORK_IP_RANGE

          docker network create \
            --driver bridge \
            --subnet "$DOCKER_NETWORK_SUBNET" \
            --gateway "$DOCKER_NETWORK_GATEWAY" \
            --ip-range "$DOCKER_NETWORK_IP_RANGE" \
            $DOCKER_NETWORK

      - name: Login to DockerHub registry
        run: echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin

      - name: Compose Users API test
        run: docker compose --verbose --file docker/docker-compose.test.yml --profile users-api up --build --abort-on-container-exit

  cd:
    name: Users API CD
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    needs: ci
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build production Users API image
        run: |
          docker build \
            --file docker/configs/users-api/Dockerfile.prod \
            --tag "${USERS_API_IMAGE}-prod" \
            --build-arg USERS_API_PORT=$USERS_API_PORT \
            .

      - name: Login to DockerHub registry
        run: echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin

      - name: Push production Users API image
        run: docker push "${USERS_API_IMAGE}-prod"

      - name: Pull and run Users API image on remote host
        uses: appleboy/ssh-action@v1.0.0
        env:
          USERS_API_IMAGE: ${{ vars.DOCKER_PREFIX }}:users-api
          USERS_API_CONTAINER: users-api

          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
          DOCKER_NETWORK: ${{ vars.DOCKER_NETWORK }}

          USERS_API_IP: ${{ vars.USERS_API_IP }}
          USERS_API_PORT: ${{ vars.USERS_API_PORT }}
        with:
          host: $SSH_HOST
          port: $SSH_PORT
          username: $SSH_USERNAME
          password: $SSH_PASSWORD
          envs:
            USERS_API_IMAGE,
            USERS_API_CONTAINER,

            DOCKERHUB_USERNAME,
            DOCKERHUB_PASSWORD,
            DOCKER_NETWORK,

            USERS_API_IP,
            USERS_API_PORT,

            NODE_ENV,
            USERS_API_IMAGE_PROD,
            OLD_IMAGE
          script: |
            set -e
            export USERS_API_IMAGE=$USERS_API_IMAGE
            export USERS_API_CONTAINER=$USERS_API_CONTAINER

            export DOCKER_NETWORK=$DOCKER_NETWORK
            export DOCKERHUB_USERNAME=$DOCKERHUB_USERNAME
            export DOCKERHUB_PASSWORD=$DOCKERHUB_PASSWORD

            export USERS_API_IP=$USERS_API_IP
            export USERS_API_PORT=$USERS_API_PORT

            export NODE_ENV=prod
            export USERS_API_IMAGE_PROD="${USERS_API_IMAGE}-prod"

            export OLD_IMAGE=$(docker images -q $USERS_API_IMAGE_PROD)$(echo "fallback")

            echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin
            docker pull $USERS_API_IMAGE_PROD

            docker stop $USERS_API_CONTAINER || true
            docker container rm -f $USERS_API_CONTAINER
            docker image rm -f $OLD_IMAGE

            command="docker run -dit \
              --restart unless-stopped \
              --publish $USERS_API_PORT:$USERS_API_PORT \
              --name $USERS_API_CONTAINER \
              --net $DOCKER_NETWORK \
              --ip $USERS_API_IP \
              --env $USERS_API_PORT \
              --env $NODE_ENV \
              $USERS_API_IMAGE_PROD"
            echo $command
            eval $command
            docker ps
